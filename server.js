// server.js

const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors');
const fs = require('fs');
const path = require('path');

// üöß AVERTISSEMENT IMPORTANT : 
// Ce backend est con√ßu pour s'int√©grer harmonieusement avec le client Papyrus tel quel.
// Modifier la logique sous-jacente sans connaissance approfondie est fortement d√©conseill√©.

// Ce fichier (server.js) et le reste du backend sont open-source et auto-h√©bergeables !
// Cela signifie que vous, l'utilisateur avanc√©, pouvez g√©rer vos notes de mani√®re
// totalement d√©centralis√©e. Ce serveur est votre "point de synchronisation" personnel.

// --- Configuration Initiale ---

let config;
try {
  config = require('./config');
} catch (error) {
  if (error.code === 'MODULE_NOT_FOUND' && error.message.includes('./config')) {
    console.error("Oops ! Le fichier 'config.js' est introuvable. C'est la base de notre serveur !");
    console.error("Il semble que l'assistant d'installation n'ait pas encore √©t√© ex√©cut√©.");
    console.error("Pour d√©marrer, veuillez lancer `npm run build` dans votre terminal.");
    process.exit(1); 
  } else {
    throw error;
  }
}

// --- Gestion de la Base de Donn√©es ---

// C'est ici que nous g√©rons notre persistance de donn√©es.
// Actuellement, nous supportons une base de donn√©es JSON simple, id√©ale pour l'auto-h√©bergement l√©ger.
// üí° Envie d'ajouter une nouvelle base de donn√©es (SQL, MongoDB, etc.) ?
// C'est l'endroit id√©al pour le faire ! Pensez √† une interface commune
// pour les op√©rations CRUD (Create, Read, Update, Delete) afin de garder notre code propre
// et de permettre √† d'autres types de bases de donn√©es de s'int√©grer facilement ici.
let db;
if (config.dbType === 'json') {
  const LitejsonDB = require('litejsondb');
  db = new LitejsonDB({ dbDir: config.json.dbDir, filename: config.json.dbFile });
  if (!db.has('notes')) db.set('notes', {});
  if (!db.has('categories')) db.set('categories', {});
  console.log(`üéâ Base de donn√©es JSON charg√©e avec succ√®s depuis : ${path.join(config.json.dbDir, config.json.dbFile)}`);
} else {
  // Actuellement, nous ne supportons que le type 'json'.
  // üöß C'est un point d'extension majeur pour les contributeurs !
  // Pour une meilleure modularit√©, nous pourrions cr√©er un dossier 'db_handlers'
  // avec des fichiers comme json_handler.js, sql_handler.js, etc.
  // Chaque handler exposerait des fonctions comme init(), get(), set(), delete().
  throw new Error(`Le type de base de donn√©es '${config.dbType}' n'est pas encore impl√©ment√©. Envie de contribuer ?`);
}

const app = express();

// --- Configuration CORS (Cross-Origin Resource Sharing) ---

// üì° Le front-end de l'application Papyrus est une application propri√©taire.
// Cependant, ce backend est con√ßu pour √™tre open-cloud et auto-h√©bergeable.
// Cela signifie que vous pouvez connecter votre application Papyrus √† ce serveur !
// Pour que l'application Papyrus puisse communiquer avec ce serveur personnel,
// nous devons configurer CORS (Cross-Origin Resource Sharing).
// Cette configuration permet la synchronisation de vos notes de mani√®re d√©centralis√©e
// sur diff√©rents appareils connect√©s √† votre serveur.

if (config.cors === true) {
  app.use(cors());
} else {
  // Si config.cors est false ou autre, CORS est d√©sactiv√©.
  // Le serveur n'acceptera alors que les requ√™tes du m√™me domaine, ce qui est tr√®s restrictif
  // et emp√™chera l'application Papyrus de se connecter.
  app.use(cors({ origin: false }));
  console.log("‚ùå L'application Papyrus ne pourra pas communiquer avec ce serveur dans cette configuration.");
}

app.use(bodyParser.json());

// --- Middleware d'Authentification ---

// Middleware d'authentification : la porte d'entr√©e de l'API de votre serveur Papyrus.
// üóùÔ∏è La serverKey d√©finie dans config.js est utilis√©e pour connecter un appareil Papyrus √† votre service personnel.
// Elle doit √™tre renseign√©e dans votre application Papyrus pour activer la synchronisation.
// Vous pouvez la partager entre vos propres appareils (mobile, tablette) si vous utilisez le m√™me serveur.
// Sans la bonne cl√© toute tentative de communication avec l'API sera rejet√©e.

app.use((req, res, next) => {
  const auth = req.headers['authorization'];

  if (!auth || !auth.startsWith('Bearer ')) {
    return res.status(401).json({
      ok: false,
      error: "Authentification requise.",
    });
  }

  const token = auth.split(' ')[1];

  if (token === config.serverKey) {
    return next();
  }

  // ‚ùå Cl√© incorrecte. Rejette la requ√™te.
  return res.status(403).json({
    ok: false,
    error: "Cl√© serveur invalide. V√©rifiez votre configuration dans l'application Papyrus et sur votre serveur.",
  });
});

/**
 * ‚ö†Ô∏è AVERTISSEMENT CRITIQUE : NE PAS MODIFIER LA LOGIQUE INTERNE DE CES FONCTIONS ET DES ROUTES APIS ‚ö†Ô∏è
 *
 * Ces fonctions sont vitales pour
 * l'int√©grit√© et la stabilit√© de l'application cliente Papyrus.
 * L'application propri√©taire Papyrus repose sur une structure de donn√©es et une logique
 * d'interaction strictes avec ce backend.
 *
 * üîê TOUTE MODIFICATION, M√äME MINEURE, DE CES FONCTIONS OU DE LA STRUCTURE DES OBJETS G√âR√âS
 * (notes, cat√©gories) POURRAIT :
 *   - Casser la synchronisation entre vos appareils.
 *   - Entra√Æner des pertes de donn√©es (temporaires ou permanentes).
 *   - Rendre vos notes illisibles ou inaccessibles dans l'application.
 *   - Cr√©er des incoh√©rences qui sont difficiles √† r√©soudre.
 *
 * Le client Papyrus attend un format tr√®s pr√©cis de donn√©es. Alt√©rer ce format revient √†
 * changer le langage que parlent le client et le serveur, les rendant incompatibles.
 *
 * Ce backend est un point de synchronisation. Les autres parties de l'application Papyrus
 * (UI, UX, logique locale de gestion des notes) ne doivent JAMAIS √™tre alt√©r√©es ou
 * contourn√©es en modifiant ce code. Concentrez-vous sur l'h√©bergement et la maintenance.
 *
 * Si vous √™tes curieux de comprendre, analysez ces fonctions, mais ABSTENEZ-VOUS DE LES MODIFIER.
 */

// Cela inclut la gestion des champs obligatoires et l'ajout de valeurs par d√©faut si n√©cessaire.
const normalizeNote = (note) => {
  const content = note.content || '';
  return {
    id: note.id,
    title: note.title || content.substring(0, 60).replace(/^[#*-\s>!`]+|[\n\r]+$/g, '').trim() + (content.length > 60 ? '...' : ''),
    content: content || 'Pas de contenu',
    timestamp: note.timestamp || new Date().toISOString(), 
    category: note.category || 'G√©n√©ral', 
    pinned: typeof note.pinned === 'boolean' ? note.pinned : false, 
    protected: typeof note.protected === 'boolean' ? note.protected : false, 
    password: note.password || null, // LE MOT DE PASSE DU NOTE EST ENCOD√âE SUR L'APPLICATION.
    isDeleted: !!note.isDeleted, 
    deleteSession: note.deleteSession || null // Papyrus auto-g√©n√®re une sessionId pour vos appareils
  };
};

const normalizeCategory = (cat) => ({
  name: cat.name,
  icon: cat.icon || 'ri-folder-line', 
  color: cat.color || 'bg-gray-500', 
  userDefined: typeof cat.userDefined === 'boolean' ? cat.userDefined : true, 
  isDeleted: !!cat.isDeleted, 
  deleteSession: cat.deleteSession || null 
});

const categoryExists = (name) => {
  const cat = db.get(`categories/${name}`);
  return cat && !cat.isDeleted;
};

// CE CODE EST LA SEULE INTERFACE AVEC LA LOGIQUE INTERNE DE L'APPLICATION.
// TOUTE MODIFICATION, M√äME MINEURE, PEUT BRISER LA SYNCHRONISATION, ENTRA√éNER UNE PERTE DE DONN√âES,
// OU RENDRE L'APPLICATION CLIENTE INUTILISABLE AVEC CE BACKEND.
// CE N'EST PAS LE LIEU POUR DE LA REVERSE ENGINEERING OU DU D√âTOURNAILLEMENT.
// POUR VOTRE S√âCURIT√â ET CELLE DE VOS DONN√âES, NE PAS TOUCHER.
// POUR LES CURIEUX : CE SONT LES ROUTES API. LEUR LOGIQUE EST MINIMALE POUR LA STABILIT√â.


app.get('/getAll', (_, res) => res.json({ok:!0,notes:Object.values(db.get('notes')||{}).map(normalizeNote),categories:Object.values(db.get('categories')||{}).map(normalizeCategory)}));

app.post('/addCategory', (req, res) => {
  const d=req.body;
  if(!d.name)return res.status(400).json({ok:!1,error:'Nom requis.'});
  if(categoryExists(d.name))return res.status(409).json({ok:!1,error:'Cat√©gorie active existe d√©j√†.'});
  const n=normalizeCategory(d),e=db.get(`categories/${d.name}`);
  if(e&&e.isDeleted){n.isDeleted=!1;n.deleteSession=null;console.log(`Cat√©gorie "${d.name}" r√©activ√©e.`);}
  db.set(`categories/${d.name}`,n);db.saveNow();
  res.status(201).json({ok:!0,message:"Cat√©gorie ajout√©e/r√©activ√©e."});
});

app.delete('/deleteCategory/:name', (req, res) => {
  const {name}=req.params,s=req.query.session,p=req.query.deleteforever==='true';
  if(!db.has(`categories/${name}`))return res.status(404).json({ok:!1,error:'Cat√©gorie non trouv√©e.'});
  const c=db.get(`categories/${name}`);
  if(p){if(s&&c.deleteSession&&s===c.deleteSession)return res.json({ok:!1,ignored:!0,reason:'Op√©ration ignor√©e (m√™me session).'});
    db.delete(`categories/${name}`);db.saveNow();
    return res.json({ok:!0,deleted:'permanent',message:`Cat√©gorie "${name}" supprim√©e.`});}
  c.isDeleted=!0;c.deleteSession=s||null;
  db.set(`categories/${name}`,c);db.saveNow();
  res.json({ok:!0,deleted:'soft',message:`Cat√©gorie "${name}" marqu√©e supprim√©e.`});
});

app.delete('/deleteNote/:id', (req, res) => {
  const {id}=req.params,p=req.query.deleteforever==='true',s=req.query.session;
  if(!db.has(`notes/${id}`))return res.status(404).json({ok:!1,error:'Note non trouv√©e.'});
  const n=db.get(`notes/${id}`);
  if(p){if(s&&n.deleteSession&&s===n.deleteSession)return res.json({ok:!1,ignored:!0,reason:'Op√©ration ignor√©e (m√™me session).'});
    db.delete(`notes/${id}`);db.saveNow();
    return res.json({ok:!0,deleted:'permanent',message:`Note ID "${id}" supprim√©e.`});}
  n.isDeleted=!0;n.deleteSession=s||null;
  db.set(`notes/${id}`,n);db.saveNow();
  res.json({ok:!0,deleted:'soft',message:`Note ID "${id}" marqu√©e supprim√©e.`});
});

app.post('/addNote', (req, res) => {
  const {id,title,content,timestamp,category,pinned,protected,password}=req.body;
  if(typeof content!=='string')return res.status(400).json({ok:!1,error:'Contenu note requis.'});
  const nId=id||(Date.now()+'_'+Math.random().toString(36).substring(2,6)),fN=normalizeNote({id:nId,title,content,timestamp,category,pinned,protected,password});
  const eN=db.get(`notes/${nId}`);
  if(eN&&eN.isDeleted){fN.isDeleted=!1;fN.deleteSession=null;console.log(`Note ID "${nId}" r√©activ√©e.`);}
  db.set(`notes/${nId}`,fN);db.saveNow();
  res.json({ok:!0,id:nId,message:`Note ID "${nId}" ajout√©e/mise √† jour.`});
});

app.put('/updateCategory/:oldName', (req, res) => {
  const {oldName}=req.params,{newName}=req.body;
  if(!db.has(`categories/${oldName}`))return res.status(404).json({ok:!1,error:'Cat√©gorie √† renommer non trouv√©e.'});
  if(!newName)return res.status(400).json({ok:!1,error:'Nouveau nom de cat√©gorie obligatoire.'});
  if(categoryExists(newName))return res.status(409).json({ok:!1,error:`Nouveau nom "${newName}" existe d√©j√†.`});
  const oC=db.get(`categories/${oldName}`),nC={...oC,name:newName};
  db.delete(`categories/${oldName}`);db.set(`categories/${newName}`,nC);
  Object.values(db.get('notes')||{}).forEach(n=>{if(n.category===oldName){n.category=newName;db.set(`notes/${n.id}`,n);}});
  db.saveNow();
  res.json({ok:!0,message:`Cat√©gorie "${oldName}" renomm√©e en "${newName}" et notes mises √† jour.`});
});

app.delete('/deleteAll', (req, res) => {
  const s=req.query.session;
  if(!s)return res.status(400).json({ok:!1,error:'ID de session manquant.'});
  const n=db.get('notes')||{},c=db.get('categories')||{};
  for(const nId in n){const nt=n[nId];if(!nt.password){nt.isDeleted=!0;nt.deleteSession=s;db.set(`notes/${nId}`,normalizeNote(nt));}}
  for(const cN in c){const ct=c[cN];ct.isDeleted=!0;ct.deleteSession=s;db.set(`categories/${cN}`,normalizeCategory(ct));}
  db.saveNow();
  res.json({ok:!0,message:"Notes (non prot√©g√©es) et cat√©gories marqu√©es supprim√©es logiquement."});
});


// --- Lancement du Serveur ---
app.listen(config.port, config.bindAddress, () => {
  console.log(`\nüéâ PapyrusDb est en ligne ! Acc√©dez √† son API via http://${config.bindAddress}:${config.port}`);
  console.log(`üîë Votre cl√© serveur : ${config.serverKey} (Gardez-la SECR√àTE ! Elle permet la connexion √† votre serveur)`);
});